<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>å¸Œæœ›ãƒ«ãƒ¼ãƒˆ vs ææ¡ˆãƒ«ãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root{
      --line:#e5e7eb; --muted:#6b7280; --radius:12px;
      --foot:#2563eb; --bike:#059669; --car:#f59e0b; --bus:#8b5cf6; --taxi:#ef4444;
      --stay:#6b7280; --tile-border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,"Noto Sans JP",sans-serif;background:#fafafa;color:#111}
    header{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;background:#fff}
    header a{margin-left:auto;font-size:12px}
    main{
      display:grid; 
      grid-template-columns:1fr 1fr; 
      grid-template-rows:auto auto auto 1fr auto auto;
      gap:8px; 
      padding:16px 16px 0 16px;
      height:calc(100vh - 62px);
    }
    .col{display:grid; grid-template-rows:auto auto 1fr auto; gap:8px; min-height:0}
    .title{margin:0; font-size:15px; font-weight:700; text-align:center}
    .total-satisfaction{
      background:#f0f9ff;
      border:2px solid #3b82f6;
      border-radius:8px;
      padding:6px 12px;
      text-align:center;
      font-size:15px;
      font-weight:700;
      color:#1e40af;
    }
    .total-satisfaction .label{
      display:inline;
      font-size:14px;
      font-weight:400;
      color:#6b7280;
      margin-right:6px;
    }
    .total-satisfaction .diff{
      font-size:14px;
      margin-left:8px;
      color:#059669;
    }
    .persuasive-text{
      background:#fffbeb;
      border:2px solid #f59e0b;
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      line-height:1.6;
      color:#78350f;
      grid-column:1 / -1;
      display:flex;
      gap:12px;
    }
    .persuasive-text .label{
      font-weight:700;
      font-size:13px;
      color:#92400e;
      display:flex;
      align-items:flex-start;
      gap:4px;
      white-space:nowrap;
      flex-shrink:0;
    }
    .persuasive-text .label::before{
      content:"ğŸ’¡";
      font-size:16px;
    }
    .persuasive-text-content{
      flex:1;
      padding-left:12px;
      border-left:2px solid #f59e0b;
    }
    .legend-container{
      grid-column:1 / -1;
      padding-bottom:16px;
    }
    .legend-toggle{
      background:#f9fafb;
      border:1px solid var(--line);
      border-radius:8px;
      padding:10px 16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-size:13px;
      font-weight:600;
      color:#374151;
      transition:all 0.2s;
    }
    .legend-toggle:hover{
      background:#f3f4f6;
    }
    .legend-toggle::before{
      content:"ğŸ“–";
      font-size:16px;
    }
    .legend-toggle.open::after{
      content:"â–²";
      margin-left:auto;
    }
    .legend-toggle:not(.open)::after{
      content:"â–¼";
      margin-left:auto;
    }
    .legend-content{
      max-height:0;
      overflow:hidden;
      transition:max-height 0.3s ease;
      background:#fff;
      border:1px solid var(--line);
      border-top:none;
      border-radius:0 0 8px 8px;
      padding:0 16px;
    }
    .legend-content.open{
      max-height:500px;
      padding:16px;
    }
    .legend-section{
      margin-bottom:10px;
      font-size:12px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .legend-section:last-child{
      margin-bottom:0;
    }
    .legend-section-title{
      font-weight:700;
      color:#374151;
      white-space:nowrap;
      min-width:70px;
    }
    .legend-items{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      flex:1;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .legend-color{
      width:20px;
      height:4px;
      border-radius:2px;
    }
    .legend-dot{
      width:16px;
      height:16px;
      border-radius:50%;
    }
    .legend-icon{
      height:20px;
    }
    .split{
      display:grid; 
      grid-template-columns:minmax(300px, 5fr) minmax(280px, 4fr); 
      gap:14px; 
      min-height:0;
      height:100%;
    }
    .map{border:1px solid var(--tile-border); border-radius:12px; overflow:hidden; background:#fff}
    #mapL,#mapR{width:100%; height:100%}
    .timeline{
      border:1px solid var(--tile-border); border-radius:12px; overflow:auto; background:#fff;
      padding:10px;
    }
    .item{
      display:grid; 
      grid-template-columns:20px 45px minmax(100px, 1fr) 40px 40px; 
      gap:6px; 
      align-items:center;
      padding:8px; 
      border-radius:8px; 
      margin-bottom:8px;
      background:#fff; 
      border:1px solid var(--line);
      transition: all 0.3s ease;
    }
    .item .num{
      font-size:14px; 
      font-weight:700; 
      color:#2563eb;
      text-align:center;
    }
    .item .time-cell{
      font-variant-numeric:tabular-nums; 
      font-weight:700; 
      font-size:14px;
      padding:6px;
      border-radius:6px;
      text-align:center;
      background:#fff;
      transition: background-color 0.3s ease;
      line-height:1.2;
      white-space:pre;
    }
    .item .time-cell.changed{
      background:#fff3cd;
      border:2px solid #ffc107;
    }
    .item .poi-cell{
      font-weight:600; 
      font-size:13px;
      line-height:1.3;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      word-break:break-word;
    }
    .item .icon-cell{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .item .icon-cell img{
      height:28px;
      width:28px;
      object-fit:contain;
    }
    .legend{display:flex; gap:14px; align-items:center; flex-wrap:wrap; font-size:12px; color:var(--muted)}
    .sw{display:inline-flex; align-items:center; gap:6px}
    .sw>i{display:inline-block; width:22px; height:4px; border-radius:4px}
    @media(max-width:1400px){
      .split{grid-template-columns:minmax(300px, 1fr) minmax(280px, 1fr);}
      .item{grid-template-columns:18px 40px minmax(90px, 1fr) 38px 38px;}
    }
    @media(max-width:1200px){
      main{grid-template-columns:1fr;}
      .split{grid-template-columns:minmax(300px, 5fr) minmax(250px, 4fr);}
    }
    @media(max-width:900px){
      .split{grid-template-columns:1fr;}
      .item{grid-template-columns:18px 40px minmax(80px, 1fr) 36px 36px; gap:4px; padding:6px;}
    }
    .cat-æ­´å²ç¥ç¤¾ä»é–£{--cat:#8b5cf6}
    .cat-æ–‡åŒ–ãƒ»ç¾è¡“{--cat:#06b6d4}
    .cat-è‡ªç„¶ãƒ»å…¬åœ’{--cat:#10b981}
    .cat-ã‚°ãƒ«ãƒ¡{--cat:#ef4444}
    .cat-è²·ã„ç‰©ãƒ»ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°{--cat:#f97316}
    .cat-ä½“é¨“æ–½è¨­{--cat:#84cc16}
    .cat-å®¿æ³Š{--cat:#64748b}
    .user-selector{
      padding:8px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:6px;
      font-size:14px;
    }
  </style>
</head>
<body>
  <header>
    <strong>å¸Œæœ›ãƒ«ãƒ¼ãƒˆ vs ææ¡ˆãƒ«ãƒ¼ãƒˆ</strong>
    <select id="userSelector" class="user-selector">
      <option value="User_1">User 1ï¼ˆå¤§å¹…å¤‰æ›´ï¼‰</option>
      <option value="User_2">User 2ï¼ˆä¸­ç¨‹åº¦å¤‰æ›´ï¼‰</option>
      <option value="User_3">User 3ï¼ˆå°å¤‰æ›´ï¼‰</option>
    </select>
    <span style="font-size:12px;color:#6b7280" id="userTypeDisplay"></span>
    <a href="/">â† æ—¢å­˜ã®åœ°å›³UIã¸</a>
  </header>

  <main>
    <section class="col">
      <h2 class="title">å¸Œæœ›</h2>
      <div class="total-satisfaction">
        <span class="label">ç·æº€è¶³åº¦ï¼š</span><span id="desiredTotal">-</span>
      </div>
      <div class="split">
        <div class="map"><div id="mapL"></div></div>
        <div class="timeline" id="tlL"></div>
      </div>
    </section>

    <section class="col">
      <h2 class="title">ææ¡ˆ</h2>
      <div class="total-satisfaction">
        <span class="label">ç·æº€è¶³åº¦ï¼š</span><span id="proposalTotal">-</span><span class="diff" id="totalDiff"></span>
      </div>
      <div class="split">
        <div class="map"><div id="mapR"></div></div>
        <div class="timeline" id="tlR"></div>
      </div>
    </section>

    <!-- èª¬å¾—æ–‡ï¼ˆå…¨å¹…ï¼‰ -->
    <div class="persuasive-text" id="persuasiveText" style="display:none;">
      <div class="persuasive-text-content" id="persuasiveTextContent"></div>
    </div>

    <!-- å‡¡ä¾‹ï¼ˆå…¨å¹…ã€ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
    <div class="legend-container">
        <div class="legend-toggle" id="legendToggle">å‡¡ä¾‹ã‚’è¡¨ç¤º</div>
        <div class="legend-content" id="legendContent">
          <div class="legend-section">
            <div class="legend-section-title">ç§»å‹•æ‰‹æ®µãƒ»POI</div>
            <div class="legend-items">
              <span class="legend-item"><span class="legend-color" style="background:var(--foot)"></span>å¾’æ­©</span>
              <span class="legend-item"><span class="legend-color" style="background:var(--bike)"></span>è‡ªè»¢è»Š</span>
              <span class="legend-item"><span class="legend-color" style="background:var(--bus)"></span>ãƒã‚¹</span>
              <span class="legend-item"><span class="legend-color" style="background:var(--taxi)"></span>ã‚¿ã‚¯ã‚·ãƒ¼</span>
              <span style="margin:0 4px;">|</span>
              <span class="legend-item"><span class="legend-dot" style="background:#8b5cf6"></span>æ­´å²ç¥ç¤¾ä»é–£</span>
              <span class="legend-item"><span class="legend-dot" style="background:#06b6d4"></span>æ–‡åŒ–ãƒ»ç¾è¡“</span>
              <span class="legend-item"><span class="legend-dot" style="background:#10b981"></span>è‡ªç„¶ãƒ»å…¬åœ’</span>
              <span class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>ã‚°ãƒ«ãƒ¡</span>
              <span class="legend-item"><span class="legend-dot" style="background:#f97316"></span>è²·ã„ç‰©</span>
              <span class="legend-item"><span class="legend-dot" style="background:#84cc16"></span>ä½“é¨“æ–½è¨­</span>
              <span class="legend-item"><span class="legend-dot" style="background:#64748b"></span>å®¿æ³Š</span>
              <span style="margin:0 4px;">|</span>
              <span class="legend-item" style="padding:4px 8px;background:#fff3cd;border:1px solid #ffc107;border-radius:4px;">å¤‰æ›´ç®‡æ‰€</span>
            </div>
          </div>
          <div class="legend-section">
            <div class="legend-section-title">æ··é›‘åº¦ãƒ»æº€è¶³åº¦</div>
            <div class="legend-items">
              <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/ç©ºã„ã¦ã„ã‚‹.png">ç©ºã„ã¦ã„ã‚‹</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/ã‚„ã‚„ç©ºã„ã¦ã„ã‚‹.png">ã‚„ã‚„ç©º</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/æ™®é€š.png">æ™®é€š</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/ã‚„ã‚„æ··é›‘.png">ã‚„ã‚„æ··</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/æ··é›‘.png">æ··é›‘</span>
              <span style="margin:0 4px;">|</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/VerySatisfied.png">ã¨ã¦ã‚‚æº€è¶³</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/Satisfied.png">æº€è¶³</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/Neutral.png">æ™®é€š</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/upset.png">ã‚„ã‚„ä¸æº€</span>
              <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/angry.png">ä¸æº€</span>
            </div>
          </div>
        </div>
      </div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    function modeToStyle(m){
      const $ = s=>getComputedStyle(document.body).getPropertyValue(s).trim();
      m=String(m||"").toLowerCase();
      if(m.includes("walk")||m.includes("å¾’æ­©")) return {profile:"foot", color:$('--foot')};
      if(m.includes("bike")||m.includes("è‡ªè»¢è»Š")||m.includes("ãƒ¬ãƒ³ã‚¿")) return {profile:"bike", color:$('--bike')};
      if(m.includes("bus")||m.includes("ãƒã‚¹")) return {profile:"car", color:$('--bus')};
      if(m.includes("taxi")||m.includes("ã‚¿ã‚¯")) return {profile:"car", color:$('--taxi')};
      if(m.includes("car")||m.includes("è»Š")) return {profile:"car", color:$('--car')};
      if(m.includes("stay")) return {profile:null, color:$('--stay')};
      return {profile:"foot", color:$('--foot')};
    }

    function makeMap(id){
      const map=L.map(id).setView([35.0153,135.7830],14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors'}).addTo(map);
      return map;
    }

    async function routeLine(profile, a, b){
      if(!profile){ return [[a.lat,a.lng],[b.lat,b.lng]]; }
      try{
        const url=`https://router.project-osrm.org/route/v1/${profile}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const r=await fetch(url); if(!r.ok) throw new Error();
        const j=await r.json();
        return j.routes[0].geometry.coordinates.map(([lon,lat])=>[lat,lon]);
      }catch(e){
        return [[a.lat,a.lng],[b.lat,b.lng]];
      }
    }

    function categoryColor(cat){
      const cls = {
        "æ­´å²ç¥ç¤¾ä»é–£":"#8b5cf6","æ–‡åŒ–ãƒ»ç¾è¡“":"#06b6d4","è‡ªç„¶ãƒ»å…¬åœ’":"#10b981",
        "ã‚°ãƒ«ãƒ¡":"#ef4444","è²·ã„ç‰©ãƒ»ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°":"#f97316","ä½“é¨“æ–½è¨­":"#84cc16","å®¿æ³Š":"#64748b"
      };
      return cls[cat] || "#3b82f6";
    }

    function row(item, comparisonItem = null, spotNumber = null){
      const el = document.createElement('div');
      el.className = 'item';

      if(item.slot === 'start' || item.slot === 'return'){
        const timeCell = `<div class="time-cell">${item.time_display}</div>`;
        const poiCell = `<div class="poi-cell">${item.poi_name}</div>`;
        el.innerHTML = '<div class="num"></div>' + timeCell + poiCell + '<div class="icon-cell"></div><div class="icon-cell"></div>';
        return el;
      }

      let hasChange = false;
      if (comparisonItem) {
        const poiChanged = item.poi_name !== comparisonItem.poi_name;
        const modeChanged = (item.mode_jp || item.mode) !== (comparisonItem.mode_jp || comparisonItem.mode);
        hasChange = poiChanged || modeChanged;
      }

      const title = item.mode_jp || item.poi_name || "-";
      const numCell = spotNumber ? `<div class="num">${spotNumber}</div>` : '<div class="num"></div>';
      const timeClass = hasChange ? 'time-cell changed' : 'time-cell';
      const timeCell = `<div class="${timeClass}">${item.time_display || ''}</div>`;
      const poiCell = `<div class="poi-cell">${title}</div>`;
      
      const congestionCell = item.congestion_img 
        ? `<div class="icon-cell"><img src="${item.congestion_img}" title="æ··é›‘åº¦"></div>`
        : '<div class="icon-cell"></div>';
      
      const satisfactionCell = item.satisfaction_img
        ? `<div class="icon-cell"><img src="${item.satisfaction_img}" title="æº€è¶³åº¦"></div>`
        : '<div class="icon-cell"></div>';

      el.innerHTML = numCell + timeCell + poiCell + congestionCell + satisfactionCell;
      return el;
    }

    async function drawPlan(map, listEl, plan, comparisonPlan = null){
      const bounds=[];
      listEl.innerHTML='';
      
      const comparisonMap = new Map();
      if (comparisonPlan) {
        comparisonPlan.forEach(p => {
          if (p.slot) comparisonMap.set(p.slot, p);
        });
      }
      
      let spotNum = 0;
      let lastPoiName = null;
      const spotNumbers = new Map();
      
      plan.forEach(p => {
        if(p.slot === 'start' || p.slot === 'return') return;
        const isSpot = p.lat && p.lng && p.poi_name && !String(p.poi_name).toLowerCase().includes('move');
        if (isSpot) {
          if (p.poi_name !== lastPoiName) {
            spotNum++;
            lastPoiName = p.poi_name;
          }
          spotNumbers.set(p.slot, spotNum);
        }
      });
      
      plan.forEach(p => {
        const comparison = comparisonMap.get(p.slot);
        const num = spotNumbers.get(p.slot);
        listEl.appendChild(row(p, comparison, num));
      });

      const addedMarkers = new Map();
      plan.forEach(p=>{
        if(!p.lat||!p.lng) return;
        if(p.slot === 'start' || p.slot === 'return') return;
        if (addedMarkers.has(p.poi_name)) return;
        
        const num = spotNumbers.get(p.slot);
        
        const markerHtml = `
          <div style="
            background:${categoryColor(p.category)}; 
            color:white; 
            width:32px; 
            height:32px; 
            border-radius:50%; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            font-weight:800; 
            font-size:14px;
            border:3px solid white;
            box-shadow:0 2px 4px rgba(0,0,0,0.3);
          ">${num || ''}</div>
        `;
        
        const icon = L.divIcon({
          html: markerHtml,
          className: 'custom-marker',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
        
        L.marker([p.lat,p.lng], {icon: icon})
          .addTo(map)
          .bindPopup(
            `<b>${num ? `${num} ` : ''}${p.poi_name||""}</b><br><small>${p.category||""}</small>`
          );
        bounds.push([p.lat,p.lng]);
        addedMarkers.set(p.poi_name, true);
      });

      let lastPOI=null, carryMode=null;
      for(const cur of plan){
        if(cur.slot === 'start' || cur.slot === 'return') continue;
        const hasCoord=!!(cur.lat&&cur.lng);
        if(!hasCoord){ if(cur.mode) carryMode=cur.mode; continue; }
        if(!lastPOI){ lastPOI=cur; carryMode=cur.mode||carryMode; continue; }

        const mode = (carryMode || cur.mode || lastPOI.mode || "walk");
        const st   = modeToStyle(mode);
        const line = await routeLine(st.profile, lastPOI, cur);
        L.polyline(line, {
          color: st.color, weight: 4, opacity: 0.98,
          dashArray: (line.length===2 && st.profile) ? "6,6" : null
        }).addTo(map);

        lastPOI=cur; carryMode=null;
      }
      if(bounds.length) map.fitBounds(bounds,{padding:[18,18]});
    }

    async function init(){
      const urlParams = new URLSearchParams(window.location.search);
      const selectedUser = urlParams.get('user') || 'User_1';
      document.getElementById('userSelector').value = selectedUser;
      
      const res = await fetch(`/api/compare_geo?user=${selectedUser}`);
      const data = await res.json();
      
      document.getElementById('userTypeDisplay').textContent = `(${data.user_type})`;
      document.getElementById('desiredTotal').textContent = data.desired_total_satisfaction;
      document.getElementById('proposalTotal').textContent = data.proposal_total_satisfaction;
      const diff = data.proposal_total_satisfaction - data.desired_total_satisfaction;
      document.getElementById('totalDiff').textContent = diff > 0 ? `â¬† +${diff.toFixed(1)}` : '';
      
      // èª¬å¾—æ–‡è¡¨ç¤º
      if (data.persuasive_text) {
        document.getElementById('persuasiveTextContent').textContent = data.persuasive_text;
        document.getElementById('persuasiveText').style.display = 'block';
      } else {
        document.getElementById('persuasiveText').style.display = 'none';
      }
      
      const mapL=makeMap('mapL');
      const mapR=makeMap('mapR');
      await drawPlan(mapL, document.getElementById('tlL'), data.desired);
      await drawPlan(mapR, document.getElementById('tlR'), data.proposal, data.desired);
    }

    document.getElementById('userSelector').addEventListener('change', function(){
      const user = this.value;
      window.location.href = `?user=${user}`;
    });

    // å‡¡ä¾‹ãƒˆã‚°ãƒ«
    document.getElementById('legendToggle').addEventListener('click', function(){
      const content = document.getElementById('legendContent');
      const toggle = document.getElementById('legendToggle');
      
      if (content.classList.contains('open')) {
        content.classList.remove('open');
        toggle.classList.remove('open');
        toggle.textContent = 'å‡¡ä¾‹ã‚’è¡¨ç¤º';
      } else {
        content.classList.add('open');
        toggle.classList.add('open');
        toggle.textContent = 'å‡¡ä¾‹ã‚’éè¡¨ç¤º';
      }
    });

    init();
  </script>
</body>
</html>
