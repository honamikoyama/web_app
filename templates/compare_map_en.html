<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Desired Route vs Proposed Route</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root{
      --line:#e5e7eb; --muted:#6b7280; --radius:12px;
      --foot:#2563eb; --bike:#059669; --car:#f59e0b; --bus:#8b5cf6; --taxi:#ef4444;
      --stay:#6b7280; --tile-border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:#fafafa;color:#111}
    header{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;background:#fff}
    header a{margin-left:auto;font-size:12px}
    main{
      display:grid; 
      grid-template-columns:1fr 1fr; 
      grid-template-rows:auto auto auto 1fr auto auto;
      gap:8px; 
      padding:16px 16px 0 16px;
      height:calc(100vh - 62px);
    }
    .col{display:grid; grid-template-rows:auto auto 1fr auto; gap:8px; min-height:0}
    .title{margin:0; font-size:15px; font-weight:700; text-align:center}
    .total-satisfaction{
      background:#f0f9ff;
      border:2px solid #3b82f6;
      border-radius:8px;
      padding:6px 12px;
      text-align:center;
      font-size:15px;
      font-weight:700;
      color:#1e40af;
    }
    .total-satisfaction .label{
      display:inline;
      font-size:14px;
      font-weight:400;
      color:#6b7280;
      margin-right:6px;
    }
    .total-satisfaction .diff{
      font-size:14px;
      margin-left:8px;
      color:#059669;
    }
    .persuasive-text{
      background:#fffbeb;
      border:2px solid #f59e0b;
      border-radius:8px;
      padding:12px 16px;
      font-size:16px;
      line-height:1.6;
      color:#78350f;
      grid-column:1 / -1;
      display:flex;
      gap:12px;
    }
    .persuasive-text .label{
      font-weight:700;
      font-size:13px;
      color:#92400e;
      display:flex;
      align-items:flex-start;
      gap:4px;
      white-space:nowrap;
      flex-shrink:0;
    }
    .persuasive-text .label::before{
      content:"üí°";
      font-size:16px;
    }
    .persuasive-text-content{
      flex:1;
      padding-left:12px;
      border-left:2px solid #f59e0b;
    }
    .legend-container{
      grid-column:1 / -1;
      padding-bottom:16px;
    }
    .legend-content{
      background:#fff;
      border:1px solid var(--line);
      border-radius:8px;
      padding:16px;
    }
    .legend-section{
      margin-bottom:10px;
      font-size:12px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .legend-section:last-child{
      margin-bottom:0;
    }
    .legend-section-title{
      font-weight:700;
      color:#374151;
      white-space:nowrap;
      min-width:120px;
    }
    .legend-items{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      flex:1;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .legend-color{
      width:20px;
      height:4px;
      border-radius:2px;
    }
    .legend-dot{
      width:16px;
      height:16px;
      border-radius:50%;
    }
    .legend-icon{
      height:20px;
    }
    .split{
      display:grid; 
      grid-template-columns:minmax(300px, 5fr) minmax(280px, 4fr); 
      gap:14px; 
      min-height:0;
    }
    .map{
      border:1px solid var(--tile-border); 
      border-radius:12px; 
      overflow:hidden; 
      background:#fff;
      height:100%;
      min-height:500px;
    }
    #mapL,#mapR{width:100%; height:100%}
    .timeline{
      border:1px solid var(--tile-border); border-radius:12px; overflow:auto; background:#fff;
      padding:10px;
    }
    .item{
      display:grid; 
      grid-template-columns:20px 45px minmax(100px, 1fr) 40px 40px; 
      gap:6px; 
      align-items:center;
      padding:6px; 
      border-radius:8px; 
      margin-bottom:6px;
      background:#fff; 
      border:1px solid var(--line);
      transition: all 0.3s ease;
    }
    .item .num{
      font-size:14px; 
      font-weight:700; 
      color:#2563eb;
      text-align:center;
    }
    .item .time-cell{
      font-variant-numeric:tabular-nums; 
      font-weight:700; 
      font-size:14px;
      padding:6px;
      border-radius:6px;
      text-align:center;
      background:#fff;
      transition: background-color 0.3s ease;
      line-height:1.2;
      white-space:pre;
    }
    .item .time-cell.changed{
      background:#fff3cd;
      border:1px solid #ffc107;
    }
    .item .poi-cell{
      font-weight:600; 
      font-size:13px;
      line-height:1.3;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      word-break:break-word;
    }
    .item .poi-cell.poi{
      font-weight:700;
      color:#111;
    }
    .item .poi-cell.transport{
      color:#6b7280;
    }
    .item .icon-cell{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .item .icon-cell img{
      height:28px;
      width:28px;
      object-fit:contain;
    }
    @media(max-width:1400px){
      .split{grid-template-columns:minmax(300px, 1fr) minmax(280px, 1fr);}
      .item{grid-template-columns:18px 40px minmax(90px, 1fr) 38px 38px;}
    }
    @media(max-width:1200px){
      main{grid-template-columns:1fr;}
      .split{grid-template-columns:minmax(300px, 5fr) minmax(250px, 4fr);}
    }
    @media(max-width:900px){
      .split{grid-template-columns:1fr;}
      .item{grid-template-columns:18px 40px minmax(80px, 1fr) 36px 36px; gap:4px; padding:6px;}
    }
    .cat-Ê≠¥Âè≤Á•ûÁ§æ‰ªèÈñ£{--cat:#8b5cf6}
    .cat-ÊñáÂåñ„ÉªÁæéË°ì{--cat:#06b6d4}
    .cat-Ëá™ÁÑ∂„ÉªÂÖ¨Âúí{--cat:#10b981}
    .cat-„Ç∞„É´„É°{--cat:#ef4444}
    .cat-Ë≤∑„ÅÑÁâ©„Éª„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞{--cat:#f97316}
    .cat-‰ΩìÈ®ìÊñΩË®≠{--cat:#84cc16}
    .cat-ÂÆøÊ≥ä{--cat:#64748b}
    .user-selector{
      padding:8px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:6px;
      font-size:14px;
    }
  </style>
</head>
<body>
  <header>
    <strong>Desired Route vs Proposed Route</strong>
    <select id="userSelector" class="user-selector">
      <option value="User_1">User 1 (Major Change)</option>
      <option value="User_2">User 2 (Moderate Change)</option>
      <option value="User_3">User 3 (Minor Change)</option>
    </select>
    <span style="font-size:12px;color:#6b7280" id="userTypeDisplay"></span>
    <a href="/ui/compare-map">‚Üê Japanese Version</a>
  </header>

  <main>
    <section class="col">
      <h2 class="title">Desired</h2>
      <div class="total-satisfaction">
        <span class="label">Total Satisfaction:</span><span id="desiredTotal">-</span>
      </div>
      <div class="split">
        <div class="map"><div id="mapL"></div></div>
        <div class="timeline" id="tlL"></div>
      </div>
    </section>

    <section class="col">
      <h2 class="title">Proposed</h2>
      <div class="total-satisfaction">
        <span class="label">Total Satisfaction:</span><span id="proposalTotal">-</span><span class="diff" id="totalDiff"></span>
      </div>
      <div class="split">
        <div class="map"><div id="mapR"></div></div>
        <div class="timeline" id="tlR"></div>
      </div>
    </section>

    <!-- Persuasive Text -->
    <div class="persuasive-text" id="persuasiveText" style="display:none;">
      <div class="label">Reason</div>
      <div class="persuasive-text-content" id="persuasiveTextContent"></div>
    </div>

    <!-- Legend -->
    <div class="legend-container">
      <div class="legend-content" id="legendContent">
        <div class="legend-section">
          <div class="legend-section-title">Transport„ÉªPOI</div>
          <div class="legend-items">
            <span class="legend-item"><span class="legend-color" style="background:var(--foot)"></span>Walking</span>
            <span class="legend-item"><span class="legend-color" style="background:var(--bike)"></span>Bicycle</span>
            <span class="legend-item"><span class="legend-color" style="background:var(--bus)"></span>Bus</span>
            <span class="legend-item"><span class="legend-color" style="background:var(--taxi)"></span>Taxi</span>
            <span style="margin:0 4px;">|</span>
            <span class="legend-item"><span class="legend-dot" style="background:#8b5cf6"></span>History/Shrine/Temple</span>
            <span class="legend-item"><span class="legend-dot" style="background:#06b6d4"></span>Culture/Art</span>
            <span class="legend-item"><span class="legend-dot" style="background:#10b981"></span>Nature/Park</span>
            <span class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>Gourmet</span>
            <span class="legend-item"><span class="legend-dot" style="background:#f97316"></span>Shopping</span>
            <span class="legend-item"><span class="legend-dot" style="background:#84cc16"></span>Experience</span>
            <span class="legend-item"><span class="legend-dot" style="background:#64748b"></span>Accommodation</span>
            <span style="margin:0 4px;">|</span>
            <span class="legend-item" style="padding:4px 8px;background:#fff3cd;border:1px solid #ffc107;border-radius:4px;">Modified</span>
          </div>
        </div>
        <div class="legend-section">
          <div class="legend-section-title">Congestion„ÉªSatisfaction</div>
          <div class="legend-items">
            <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/Á©∫„ÅÑ„Å¶„ÅÑ„Çã.png">Empty</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/„ÇÑ„ÇÑÁ©∫„ÅÑ„Å¶„ÅÑ„Çã.png">Light</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/ÊôÆÈÄö.png">Normal</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/„ÇÑ„ÇÑÊ∑∑Èõë.png">Busy</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/congestion/Ê∑∑Èõë.png">Crowded</span>
            <span style="margin:0 4px;">|</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/VerySatisfied.png">Very Satisfied</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/Satisfied.png">Satisfied</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/Neutral.png">Neutral</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/upset.png">Dissatisfied</span>
            <span class="legend-item"><img class="legend-icon" src="/static/img/satisfaction/angry.png">Very Dissatisfied</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    function modeToStyle(m){
      const $ = s=>getComputedStyle(document.body).getPropertyValue(s).trim();
      m=String(m||"").toLowerCase();
      if(m.includes("walk")||m.includes("ÂæíÊ≠©")) return {profile:"foot", color:$('--foot')};
      if(m.includes("bike")||m.includes("Ëá™Ëª¢Ëªä")||m.includes("„É¨„É≥„Çø")) return {profile:"bike", color:$('--bike')};
      if(m.includes("bus")||m.includes("„Éê„Çπ")) return {profile:"car", color:$('--bus')};
      if(m.includes("taxi")||m.includes("„Çø„ÇØ")) return {profile:"car", color:$('--taxi')};
      if(m.includes("car")||m.includes("Ëªä")) return {profile:"car", color:$('--car')};
      if(m.includes("stay")) return {profile:null, color:$('--stay')};
      return {profile:"foot", color:$('--foot')};
    }

    function makeMap(id){
      const map=L.map(id).setView([35.0153,135.7830],14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(map);
      return map;
    }

    async function routeLine(profile, a, b){
      if(!profile){ return [[a.lat,a.lng],[b.lat,b.lng]]; }
      try{
        const url=`https://router.project-osrm.org/route/v1/${profile}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const r=await fetch(url); if(!r.ok) throw new Error();
        const j=await r.json();
        return j.routes[0].geometry.coordinates.map(([lon,lat])=>[lat,lon]);
      }catch(e){
        return [[a.lat,a.lng],[b.lat,b.lng]];
      }
    }

    function categoryColor(cat){
      const cls = {
        "Ê≠¥Âè≤Á•ûÁ§æ‰ªèÈñ£":"#8b5cf6","ÊñáÂåñ„ÉªÁæéË°ì":"#06b6d4","Ëá™ÁÑ∂„ÉªÂÖ¨Âúí":"#10b981",
        "„Ç∞„É´„É°":"#ef4444","Ë≤∑„ÅÑÁâ©„Éª„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞":"#f97316","‰ΩìÈ®ìÊñΩË®≠":"#84cc16","ÂÆøÊ≥ä":"#64748b"
      };
      return cls[cat] || "#3b82f6";
    }

    function row(item, comparisonItem = null, spotNumber = null){
      const el = document.createElement('div');
      el.className = 'item';

      if(item.slot === 'start' || item.slot === 'return'){
        const timeCell = `<div class="time-cell">${item.time_display === 'Âá∫Áô∫' ? 'Depart' : item.time_display === 'Â∏∞ÁùÄ' ? 'Return' : item.time_display}</div>`;
        const poiCell = `<div class="poi-cell poi">${item.poi_name}</div>`;
        el.innerHTML = '<div class="num"></div>' + timeCell + poiCell + '<div class="icon-cell"></div><div class="icon-cell"></div>';
        return el;
      }

      let hasChange = false;
      if (comparisonItem) {
        const poiChanged = item.poi_name !== comparisonItem.poi_name;
        const modeChanged = (item.mode_jp || item.mode) !== (comparisonItem.mode_jp || comparisonItem.mode);
        hasChange = poiChanged || modeChanged;
      }

      const title = item.mode_jp || item.poi_name || "-";
      const numCell = spotNumber ? `<div class="num">${spotNumber}</div>` : '<div class="num"></div>';
      const timeClass = hasChange ? 'time-cell changed' : 'time-cell';
      const timeCell = `<div class="${timeClass}">${item.time_display || ''}</div>`;
      
      const isTransport = item.poi_name && String(item.poi_name).toLowerCase().includes('move');
      const cellClass = isTransport ? 'poi-cell transport' : 'poi-cell poi';
      const poiCell = `<div class="${cellClass}">${title}</div>`;
      
      const congestionCell = item.congestion_img 
        ? `<div class="icon-cell"><img src="${item.congestion_img}" title="Congestion"></div>`
        : '<div class="icon-cell"></div>';
      
      const satisfactionCell = item.satisfaction_img
        ? `<div class="icon-cell"><img src="${item.satisfaction_img}" title="Satisfaction"></div>`
        : '<div class="icon-cell"></div>';

      el.innerHTML = numCell + timeCell + poiCell + congestionCell + satisfactionCell;
      return el;
    }

    async function drawPlan(map, listEl, plan, comparisonPlan = null){
      const bounds=[];
      listEl.innerHTML='';
      
      const comparisonMap = new Map();
      if (comparisonPlan) {
        comparisonPlan.forEach(p => {
          if (p.slot) comparisonMap.set(p.slot, p);
        });
      }
      
      let spotNum = 0;
      let lastPoiName = null;
      const spotNumbers = new Map();
      
      plan.forEach(p => {
        if(p.slot === 'start' || p.slot === 'return') return;
        const isSpot = p.lat && p.lng && p.poi_name && !String(p.poi_name).toLowerCase().includes('move');
        if (isSpot) {
          if (p.poi_name !== lastPoiName) {
            spotNum++;
            lastPoiName = p.poi_name;
          }
          spotNumbers.set(p.slot, spotNum);
        }
      });
      
      plan.forEach(p => {
        const comparison = comparisonMap.get(p.slot);
        const num = spotNumbers.get(p.slot);
        listEl.appendChild(row(p, comparison, num));
      });

      const addedMarkers = new Map();
      plan.forEach(p=>{
        if(!p.lat||!p.lng) return;
        if(p.slot === 'start' || p.slot === 'return') return;
        if (addedMarkers.has(p.poi_name)) return;
        
        const num = spotNumbers.get(p.slot);
        
        const markerHtml = `
          <div style="
            background:${categoryColor(p.category)}; 
            color:white; 
            width:32px; 
            height:32px; 
            border-radius:50%; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            font-weight:800; 
            font-size:14px;
            border:3px solid white;
            box-shadow:0 2px 4px rgba(0,0,0,0.3);
          ">${num || ''}</div>
        `;
        
        const icon = L.divIcon({
          html: markerHtml,
          className: 'custom-marker',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
        
        L.marker([p.lat,p.lng], {icon: icon})
          .addTo(map)
          .bindPopup(
            `<b>${num ? `${num} ` : ''}${p.poi_name||""}</b><br><small>${p.category||""}</small>`
          );
        bounds.push([p.lat,p.lng]);
        addedMarkers.set(p.poi_name, true);
      });

      let lastPOI=null, carryMode=null;
      for(const cur of plan){
        if(cur.slot === 'start' || cur.slot === 'return') continue;
        const hasCoord=!!(cur.lat&&cur.lng);
        if(!hasCoord){ if(cur.mode) carryMode=cur.mode; continue; }
        if(!lastPOI){ lastPOI=cur; carryMode=cur.mode||carryMode; continue; }

        const mode = (carryMode || cur.mode || lastPOI.mode || "walk");
        const st   = modeToStyle(mode);
        const line = await routeLine(st.profile, lastPOI, cur);
        L.polyline(line, {
          color: st.color, weight: 4, opacity: 0.98,
          dashArray: (line.length===2 && st.profile) ? "6,6" : null
        }).addTo(map);

        lastPOI=cur; carryMode=null;
      }
      if(bounds.length) map.fitBounds(bounds,{padding:[18,18]});
    }

    async function init(){
      const urlParams = new URLSearchParams(window.location.search);
      const selectedUser = urlParams.get('user') || 'User_1';
      document.getElementById('userSelector').value = selectedUser;
      
      const res = await fetch(`/api/compare_geo_en?user=${selectedUser}`);
      const data = await res.json();
      
      document.getElementById('userTypeDisplay').textContent = `(${data.user_type})`;
      document.getElementById('desiredTotal').textContent = data.desired_total_satisfaction;
      document.getElementById('proposalTotal').textContent = data.proposal_total_satisfaction;
      const diff = data.proposal_total_satisfaction - data.desired_total_satisfaction;
      document.getElementById('totalDiff').textContent = diff > 0 ? `‚¨Ü +${diff.toFixed(1)}` : '';
      
      if (data.persuasive_text) {
        document.getElementById('persuasiveTextContent').textContent = data.persuasive_text;
        document.getElementById('persuasiveText').style.display = 'flex';
      } else {
        document.getElementById('persuasiveText').style.display = 'none';
      }
      
      const mapL=makeMap('mapL');
      const mapR=makeMap('mapR');
      await drawPlan(mapL, document.getElementById('tlL'), data.desired);
      await drawPlan(mapR, document.getElementById('tlR'), data.proposal, data.desired);
    }

    document.getElementById('userSelector').addEventListener('change', function(){
      const user = this.value;
      window.location.href = `?user=${user}`;
    });

    init();
  </script>
</body>
</html>
