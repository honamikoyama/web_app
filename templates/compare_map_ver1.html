<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>å¸Œæœ›ãƒ«ãƒ¼ãƒˆ vs ææ¡ˆãƒ«ãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root{
      --line:#e5e7eb; --muted:#6b7280; --radius:12px;
      --foot:#2563eb; --bike:#059669; --car:#f59e0b; --bus:#8b5cf6; --taxi:#ef4444;
      --stay:#6b7280; --tile-border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,"Noto Sans JP",sans-serif;background:#fafafa;color:#111}
    header{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;background:#fff}
    header a{margin-left:auto;font-size:12px}
    main{
      display:grid; grid-template-columns:1fr 1fr; gap:16px; padding:16px;
      height:calc(100vh - 62px);
    }
    .col{display:grid; grid-template-rows:auto 1fr auto; gap:10px; min-height:0}
    .title{margin:0; font-size:16px; font-weight:700}
    /* åœ°å›³:ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ = 3:2ï¼ˆå³å´ã‚‚èª­ã¿ã‚„ã™ã„æ¯”ç‡ã«ï¼‰ */
    .split{display:grid; grid-template-columns:3fr 2fr; gap:14px; min-height:0}
    .map{border:1px solid var(--tile-border); border-radius:12px; overflow:hidden; background:#fff}
    #mapL,#mapR{width:100%; height:100%}
    .timeline{
      border:1px solid var(--tile-border); border-radius:12px; overflow:auto; background:#fff;
      padding:10px;
    }
    .item{
      display:grid; 
      grid-template-columns:50px 80px 1fr 60px 60px; 
      gap:8px; 
      align-items:center;
      padding:10px; 
      border-radius:8px; 
      margin-bottom:8px;
      background:#fff; 
      border:1px solid var(--line);
      transition: all 0.3s ease;
    }
    .item .num{
      font-size:18px; 
      font-weight:800; 
      color:#2563eb;
      text-align:center;
    }
    .item .time-cell{
      font-variant-numeric:tabular-nums; 
      font-weight:700; 
      font-size:14px;
      padding:8px;
      border-radius:6px;
      text-align:center;
      background:#fff;
      transition: background-color 0.3s ease;
    }
    .item .time-cell.changed{
      background:#fff3cd; /* å¤‰æ›´ç®‡æ‰€ã¯æ™‚åˆ»ã‚»ãƒ«ã®èƒŒæ™¯ã‚’é»„è‰²ã« */
      border:2px solid #ffc107;
    }
    .item .poi-cell{
      font-weight:600; 
      font-size:14px;
    }
    .item .icon-cell{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .item .icon-cell img{
      height:32px;
      width:32px;
      object-fit:contain;
    }
    .time{font-variant-numeric:tabular-nums; font-weight:800; font-size:14px}
    .poi{font-weight:700; font-size:15px; line-height:1.2}
    .sub{font-size:12px; color:var(--muted)}
    .chips{display:flex; gap:6px; margin-top:6px; flex-wrap:wrap}
    .chip{font-size:12px; padding:3px 10px; border-radius:999px; border:1px solid var(--line); background:#fafafa}
    .icons{display:flex; gap:10px}
    .icons img{height:28px}
    .legend{display:flex; gap:14px; align-items:center; flex-wrap:wrap; font-size:12px; color:var(--muted)}
    .sw{display:inline-flex; align-items:center; gap:6px}
    .sw>i{display:inline-block; width:22px; height:4px; border-radius:4px}
    @media(max-width:1200px){.split{grid-template-columns:1fr}}
    /* ã‚«ãƒ†ã‚´ãƒªè‰²ï¼ˆãƒ”ãƒ³ã®è‰²ã«ã‚‚åˆ©ç”¨ï¼‰ */
    .cat-æ­´å²ç¥ç¤¾ä»é–£{--cat:#8b5cf6}
    .cat-æ–‡åŒ–ãƒ»ç¾è¡“{--cat:#06b6d4}
    .cat-è‡ªç„¶ãƒ»å…¬åœ’{--cat:#10b981}
    .cat-ã‚°ãƒ«ãƒ¡{--cat:#ef4444}
    .cat-è²·ã„ç‰©ãƒ»ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°{--cat:#f97316}
    .cat-ä½“é¨“æ–½è¨­{--cat:#84cc16}
    .cat-å®¿æ³Š{--cat:#64748b}
  </style>
</head>
<body>
  <header>
    <strong>å¸Œæœ›ãƒ«ãƒ¼ãƒˆ vs ææ¡ˆãƒ«ãƒ¼ãƒˆ</strong>
    <span style="font-size:12px;color:#6b7280">å·¦ï¼šå¸Œæœ›æ¡ˆï¼ˆdesired_example.csvï¼‰/ å³ï¼šææ¡ˆæ¡ˆï¼ˆoptimal_solutions_example.csvï¼‰</span>
    <a href="/">â† æ—¢å­˜ã®åœ°å›³UIã¸</a>
  </header>

  <main>
    <!-- å·¦ï¼šå¸Œæœ›æ¡ˆ -->
    <section class="col">
      <h2 class="title">å¸Œæœ›æ¡ˆ</h2>
      <div class="split">
        <div class="map"><div id="mapL"></div></div>
        <div class="timeline" id="tlL"></div>
      </div>
      <div class="legend">
        <span class="sw"><i style="background:var(--foot)"></i>å¾’æ­©</span>
        <span class="sw"><i style="background:var(--bike)"></i>è‡ªè»¢è»Š</span>
        <span class="sw"><i style="background:var(--car)"></i>è»Š</span>
        <span class="sw"><i style="background:var(--bus)"></i>ãƒã‚¹</span>
        <span class="sw"><i style="background:var(--taxi)"></i>ã‚¿ã‚¯ã‚·ãƒ¼</span>
        <span style="margin-left:10px;padding:4px 10px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:11px;">ğŸŸ¡ æ™‚åˆ»ã‚»ãƒ«é»„è‰² = å¤‰æ›´ç®‡æ‰€</span>
      </div>
    </section>

    <!-- å³ï¼šææ¡ˆæ¡ˆ -->
    <section class="col">
      <h2 class="title">ææ¡ˆæ¡ˆ</h2>
      <div class="split">
        <div class="map"><div id="mapR"></div></div>
        <div class="timeline" id="tlR"></div>
      </div>
      <div class="legend">
        <span class="sw"><i style="background:var(--foot)"></i>å¾’æ­©</span>
        <span class="sw"><i style="background:var(--bike)"></i>è‡ªè»¢è»Š</span>
        <span class="sw"><i style="background:var(--car)"></i>è»Š</span>
        <span class="sw"><i style="background:var(--bus)"></i>ãƒã‚¹</span>
        <span class="sw"><i style="background:var(--taxi)"></i>ã‚¿ã‚¯ã‚·ãƒ¼</span>
        <span style="margin-left:10px;padding:4px 10px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:11px;">ğŸŸ¡ æ™‚åˆ»ã‚»ãƒ«é»„è‰² = å¤‰æ›´ç®‡æ‰€</span>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- äº¤é€šæ‰‹æ®µ â†’ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼†è‰²ï¼ˆè»Š/ãƒã‚¹/ã‚¿ã‚¯ã‚·ãƒ¼ã‚’åˆ¥è‰²ï¼‰ ---
    function modeToStyle(mode){
      const m=(mode||"").toLowerCase();
      const $ = s => getComputedStyle(document.documentElement).getPropertyValue(s).trim();
      if(m.includes("bicycle")||m.includes("bike")||m.includes("è‡ªè»¢è»Š")) return {profile:"bike", color:$('--bike')};
      if(m.includes("bus")||m.includes("ãƒã‚¹")) return {profile:"car", color:$('--bus')};    // OSRMã¯carã‚’åˆ©ç”¨
      if(m.includes("taxi")||m.includes("ã‚¿ã‚¯")) return {profile:"car", color:$('--taxi')};
      if(m.includes("car")||m.includes("è»Š"))    return {profile:"car", color:$('--car')};
      if(m.includes("stay")) return {profile:null, color:$('--stay')};
      return {profile:"foot", color:$('--foot')}; // walk
    }

    function makeMap(id){
      const map=L.map(id).setView([35.0153,135.7830],14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap contributors'}).addTo(map);
      return map;
    }

    async function routeLine(profile, a, b){
      if(!profile){ return [[a.lat,a.lng],[b.lat,b.lng]]; }
      try{
        const url=`https://router.project-osrm.org/route/v1/${profile}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const r=await fetch(url); if(!r.ok) throw new Error();
        const j=await r.json();
        return j.routes[0].geometry.coordinates.map(([lon,lat])=>[lat,lon]);
      }catch(e){
        return [[a.lat,a.lng],[b.lat,b.lng]]; // fallback
      }
    }

    function categoryColor(cat){
      const cls = {
        "æ­´å²ç¥ç¤¾ä»é–£":"#8b5cf6","æ–‡åŒ–ãƒ»ç¾è¡“":"#06b6d4","è‡ªç„¶ãƒ»å…¬åœ’":"#10b981",
        "ã‚°ãƒ«ãƒ¡":"#ef4444","è²·ã„ç‰©ãƒ»ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°":"#f97316","ä½“é¨“æ–½è¨­":"#84cc16","å®¿æ³Š":"#64748b"
      };
      return cls[cat] || "#3b82f6";
    }

function row(item, comparisonItem = null, spotNumber = null){
  const el = document.createElement('div');
  el.className = 'item';

  // å¤‰æ›´æ¤œå‡ºï¼šPOIåã¾ãŸã¯ç§»å‹•æ‰‹æ®µãŒå¤‰ã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
  let hasChange = false;
  
  if (comparisonItem) {
    const poiChanged = item.poi_name !== comparisonItem.poi_name;
    const modeChanged = (item.mode_jp || item.mode) !== (comparisonItem.mode_jp || comparisonItem.mode);
    hasChange = poiChanged || modeChanged;
  }

  // è¡¨ç¤ºã‚¿ã‚¤ãƒˆãƒ«ï¼ˆPOIå or ç§»å‹•æ‰‹æ®µã®æ—¥æœ¬èªï¼‰
  const title = (item.poi_name && !String(item.poi_name).toLowerCase().includes('move'))
    ? item.poi_name
    : (item.mode_jp || item.mode || "-");

  // ç•ªå·ã‚»ãƒ«ï¼ˆã‚¹ãƒãƒƒãƒˆã®ã¿ï¼‰
  const numCell = spotNumber ? `<div class="num">â“ª${spotNumber}</div>` : '<div class="num"></div>';
  
  // æ™‚åˆ»ã‚»ãƒ«ï¼ˆå¤‰æ›´ç®‡æ‰€ã¯èƒŒæ™¯è‰²å¤‰æ›´ï¼‰
  const timeClass = hasChange ? 'time-cell changed' : 'time-cell';
  const timeCell = `<div class="${timeClass}">${item.time || ""}</div>`;
  
  // POI/ç§»å‹•æ‰‹æ®µã‚»ãƒ«
  const poiCell = `<div class="poi-cell">${title}</div>`;
  
  // æ··é›‘åº¦ã‚»ãƒ«
  const congestionCell = `
    <div class="icon-cell">
      <img src="${item.congestion_img}" 
           title="æ··é›‘åº¦: ${item.congestion || '-'}" 
           onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<span style=&quot;font-size:10px;&quot;>${Math.round((item.congestion || 0) / 20)}/5</span>');">
    </div>`;
  
  // æº€è¶³åº¦ã‚»ãƒ«
  const satisfactionCell = `
    <div class="icon-cell">
      <img src="${item.satisfaction_img}" 
           title="æº€è¶³åº¦: ${item.satisfaction || '-'}" 
           onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<span style=&quot;font-size:10px;&quot;>${item.satisfaction || 0}/5</span>');">
    </div>`;

  el.innerHTML = numCell + timeCell + poiCell + congestionCell + satisfactionCell;
  return el;
}



    // moveè¡Œã‚’ã¾ãŸã„ã§ã‚‚ç·šã‚’å¼•ãï¼ˆæœ€æ–°ã®moveãƒ¢ãƒ¼ãƒ‰ã§çµã¶ï¼‰
    async function drawPlan(map, listEl, plan, comparisonPlan = null){
      const bounds=[];
      listEl.innerHTML='';
      
      // æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã§æ¯”è¼ƒç”¨ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
      const comparisonMap = new Map();
      if (comparisonPlan) {
        comparisonPlan.forEach(p => {
          if (p.time) comparisonMap.set(p.time, p);
        });
      }
      
      // ã‚¹ãƒãƒƒãƒˆç•ªå·ã‚’ä»˜ä¸ï¼ˆmoveã¯é™¤ãï¼‰
      let spotNum = 0;
      const spotNumbers = new Map();
      plan.forEach(p => {
        const isSpot = p.lat && p.lng && p.poi_name && !String(p.poi_name).toLowerCase().includes('move');
        if (isSpot) {
          spotNum++;
          spotNumbers.set(p.time, spotNum);
        }
      });
      
      // å„ã‚¢ã‚¤ãƒ†ãƒ ã«å¯¾å¿œã™ã‚‹æ¯”è¼ƒå¯¾è±¡ã¨ç•ªå·ã‚’æ¸¡ã—ã¦rowè¦ç´ ã‚’ä½œæˆ
      plan.forEach(p => {
        const comparison = comparisonMap.get(p.time);
        const num = spotNumbers.get(p.time);
        listEl.appendChild(row(p, comparison, num));
      });

      // pins with numbers
      plan.forEach(p=>{
        if(!p.lat||!p.lng) return;
        const num = spotNumbers.get(p.time);
        
        // ç•ªå·ä»˜ããƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
        const markerHtml = `
          <div style="
            background:${categoryColor(p.category)}; 
            color:white; 
            width:32px; 
            height:32px; 
            border-radius:50%; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            font-weight:800; 
            font-size:14px;
            border:3px solid white;
            box-shadow:0 2px 4px rgba(0,0,0,0.3);
          ">${num || ''}</div>
        `;
        
        const icon = L.divIcon({
          html: markerHtml,
          className: 'custom-marker',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
        
        L.marker([p.lat,p.lng], {icon: icon})
          .addTo(map)
          .bindPopup(
            `<b>${num ? `â“ª${num} ` : ''}${p.poi_name||""}</b><br><small>${p.category||""}</small><br>
             <img src="${p.congestion_img}" style="height:28px"> 
             <img src="${p.satisfaction_img}" style="height:28px">`
          );
        bounds.push([p.lat,p.lng]);
      });

      let lastPOI=null, carryMode=null;
      for(const cur of plan){
        const hasCoord=!!(cur.lat&&cur.lng);
        if(!hasCoord){ if(cur.mode) carryMode=cur.mode; continue; }
        if(!lastPOI){ lastPOI=cur; carryMode=cur.mode||carryMode; continue; }

        const mode = (carryMode || cur.mode || lastPOI.mode || "walk");
        const st   = modeToStyle(mode);
        const line = await routeLine(st.profile, lastPOI, cur);
        L.polyline(line, {
          color: st.color, weight: 4, opacity: 0.98,
          dashArray: (line.length===2 && st.profile) ? "6,6" : null
        }).addTo(map);

        lastPOI=cur; carryMode=null;
      }
      if(bounds.length) map.fitBounds(bounds,{padding:[18,18]});
    }

    async function init(){
      const res = await fetch('/api/compare_geo');
      const data = await res.json();
      const mapL=makeMap('mapL');
      const mapR=makeMap('mapR');
      
      // å·¦ï¼ˆå¸Œæœ›æ¡ˆï¼‰ã¯ææ¡ˆæ¡ˆã¨æ¯”è¼ƒã€å³ï¼ˆææ¡ˆæ¡ˆï¼‰ã¯å¸Œæœ›æ¡ˆã¨æ¯”è¼ƒ
      await drawPlan(mapL, document.getElementById('tlL'), data.desired||[], data.proposal||[]);
      await drawPlan(mapR, document.getElementById('tlR'), data.proposal||[], data.desired||[]);
    }
    init();
  </script>
</body>
</html>
